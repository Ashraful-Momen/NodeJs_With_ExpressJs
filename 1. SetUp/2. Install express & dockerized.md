# Push/Pull Node.js Express Image to Harbor - Complete Guide

---

## Step 1: Create Project Structure

### Create working directory
```bash
mkdir -p ~/nodejs-express-app
cd ~/nodejs-express-app
```

### Create necessary files
```bash
touch app.js package.json Dockerfile .dockerignore
```

---

## Step 2: Create Node.js Express Application

### Edit package.json
```bash
nano package.json
```

Add this content:
```json
{
  "name": "express-app",
  "version": "1.0.0",
  "description": "Simple Express.js application",
  "main": "app.js",
  "scripts": {
    "start": "node app.js",
    "dev": "node app.js"
  },
  "keywords": ["express", "nodejs"],
  "author": "Your Name",
  "license": "ISC",
  "dependencies": {
    "express": "^4.18.2"
  }
}
```

Save: `Ctrl + X` → `Y` → `Enter`

### Edit app.js
```bash
nano app.js
```

Add this content:
```javascript
const express = require('express');
const app = express();
const PORT = process.env.PORT || 3000;

// Middleware
app.use(express.json());

// Routes
app.get('/', (req, res) => {
  res.json({
    message: 'Welcome to Harbor Express App',
    status: 'running',
    version: '1.0.0',
    timestamp: new Date()
  });
});

app.get('/health', (req, res) => {
  res.json({
    status: 'healthy',
    uptime: process.uptime()
  });
});

app.get('/api/info', (req, res) => {
  res.json({
    app: 'Express App',
    environment: 'production',
    nodejs: process.version,
    platform: process.platform
  });
});

app.get('/api/hello/:name', (req, res) => {
  const name = req.params.name;
  res.json({
    message: `Hello, ${name}!`,
    timestamp: new Date()
  });
});

// Error handling
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).json({ error: 'Something went wrong!' });
});

// Start server
app.listen(PORT, () => {
  console.log(`✓ Express app running on port ${PORT}`);
  console.log(`✓ Health check: http://localhost:${PORT}/health`);
  console.log(`✓ API Info: http://localhost:${PORT}/api/info`);
});
```

Save: `Ctrl + X` → `Y` → `Enter`

---

## Step 3: Create Dockerfile

### Edit Dockerfile
```bash
nano Dockerfile
```

Add this content:
```dockerfile
# Use lightweight Node.js image
FROM node:18-alpine

# Set working directory
WORKDIR /app

# Copy package.json and package-lock.json
COPY package.json ./

# Install dependencies
RUN npm install --production

# Copy application code
COPY app.js ./

# Expose port
EXPOSE 3000

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD node -e "require('http').get('http://localhost:3000/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"

# Start application
CMD ["npx", "nodemon", "app.js"]
#CMD ["npm", "start"]
```

Save: `Ctrl + X` → `Y` → `Enter`

### Edit .dockerignore
```bash
nano .dockerignore
```

Add this content:
```
node_modules
npm-debug.log
.git
.gitignore
README.md
.env
.DS_Store
```

Save: `Ctrl + X` → `Y` → `Enter`

---

## Step 4: Build Docker Image

### Build the image
```bash
docker build -t express-app:1.0 .
```

### Verify image was created
```bash
docker images | grep express-app
```

Output should show:
```
express-app    1.0    xxxxx    xxxx    xxxMB
```

### Test image locally (Optional)
```bash
docker run -d -p 3000:3000 --name express-test express-app:1.0

# Wait 2 seconds for container to start
sleep 2

# Test the app
curl http://localhost:3000

# Check health
curl http://localhost:3000/health

# Test API endpoint
curl http://localhost:3000/api/hello/Harbor

# Stop container
docker stop express-test
docker rm express-test
```

---

## Step 5: Login to Harbor

### Configure Docker for Harbor (if using self-signed certificate)

Edit Docker daemon config:
```bash
sudo nano /etc/docker/daemon.json
```

Add this:
```json
{
  "insecure-registries": ["36.255.69.72:443"]
}
```

Restart Docker:
```bash
sudo systemctl restart docker
```

### Login to Harbor
```bash
docker login -u admin -p YourPassword 36.255.69.72:443
```

Expected output:
```
Login Succeeded
WARNING! Your password will be stored unencrypted in /home/user/.docker/config.json
```

---

## Step 6: Push Image to Harbor

### Tag image for Harbor
```bash
docker tag express-app:1.0 36.255.69.72:443/myproject/express-app:1.0
```

### Verify tag
```bash
docker images | grep express-app
```

Output should show both tags:
```
express-app                            1.0    xxxxx    xxxMB
36.255.69.72:443/myproject/express-app    1.0    xxxxx    xxxMB
```

### Push image to Harbor
```bash
docker push 36.255.69.72:443/myproject/express-app:1.0
```

### Monitor push progress
```
The push refers to repository [36.255.69.72:443/myproject/express-app]
xxxxx: Pushed
xxxxx: Pushed
xxxxx: Pushed
1.0: digest: sha256:xxxxx size: xxxx
```

---

## Step 7: Verify Image in Harbor UI

### Open Harbor Dashboard
```
https://36.255.69.72:443
```

### Navigate to Image
1. Click on **Projects** in left menu
2. Click on **myproject**
3. Click on **Repositories**
4. You should see **express-app** with tag **1.0**

### View Image Details
Click on **express-app** repository to see:
- Image digest
- Size
- Push time
- Vulnerability scan results (if Trivy enabled)

---

## Step 8: Pull Image from Harbor

### Remove local image (simulate fresh pull)
```bash
docker rmi express-app:1.0
docker rmi 36.255.69.72:443/myproject/express-app:1.0
```

### Pull from Harbor
```bash
docker pull 36.255.69.72:443/myproject/express-app:1.0
```

Expected output:
```
1.0: Pulling from myproject/express-app
xxxxx: Pull complete
xxxxx: Pull complete
xxxxx: Pull complete
Digest: sha256:xxxxx
Status: Downloaded newer image for 36.255.69.72:443/myproject/express-app:1.0
```

### Verify pulled image
```bash
docker images | grep express-app
```

---

## Step 9: Run Image from Harbor

### Run container from Harbor image
```bash
docker run -d -p 3000:3000 --name harbor-express 36.255.69.72:443/myproject/express-app:1.0
```

### Verify container is running
```bash
docker ps
```

Output should show:
```
CONTAINER ID    IMAGE                                           STATUS
xxxxx           36.255.69.72:443/myproject/express-app:1.0      Up 5 seconds
```

### Test the application
```bash
# Root endpoint
curl http://localhost:3000

# Health check
curl http://localhost:3000/health

# API endpoint
curl http://localhost:3000/api/info

# Hello endpoint
curl http://localhost:3000/api/hello/Docker
```

### View logs
```bash
docker logs harbor-express

# Follow logs
docker logs -f harbor-express
```

Expected output:
```
✓ Express app running on port 3000
✓ Health check: http://localhost:3000/health
✓ API Info: http://localhost:3000/api/info
```

### Stop container
```bash
docker stop harbor-express
docker rm harbor-express
```

---

## Step 10: Push Multiple Versions (Optional)

### Build new version
```bash
# Edit app.js version to 1.1, then:
docker build -t express-app:1.1 .
```

### Tag and push
```bash
docker tag express-app:1.1 36.255.69.72:443/myproject/express-app:1.1
docker push 36.255.69.72:443/myproject/express-app:1.1
```

### Push as latest tag
```bash
docker tag express-app:1.1 36.255.69.72:443/myproject/express-app:latest
docker push 36.255.69.72:443/myproject/express-app:latest
```

---

## Complete Command Summary

### One-time setup
```bash
# Create directory
mkdir -p ~/nodejs-express-app && cd ~/nodejs-express-app

# Create files
touch app.js package.json Dockerfile .dockerignore

# Configure Docker
sudo nano /etc/docker/daemon.json
# Add insecure registry, then restart Docker
sudo systemctl restart docker

# Login to Harbor
docker login -u admin -p YourPassword 36.255.69.72:443
```

### Build, Push, Pull, Run workflow
```bash
# Build
docker build -t express-app:1.0 .

# Tag for Harbor
docker tag express-app:1.0 36.255.69.72:443/myproject/express-app:1.0

# Push to Harbor
docker push 36.255.69.72:443/myproject/express-app:1.0

# Pull from Harbor
docker pull 36.255.69.72:443/myproject/express-app:1.0

# Run
docker run -d -p 3000:3000 36.255.69.72:443/myproject/express-app:1.0

# Test
curl http://localhost:3000
```

---

## Troubleshooting

### Issue: "Cannot connect to Docker daemon"
```bash
sudo usermod -aG docker $USER
newgrp docker
```

### Issue: "denied: requested access to the resource is denied"
```bash
# Make sure you're logged in
docker login -u admin -p YourPassword 36.255.69.72:443
```

### Issue: "connection refused" when accessing app
```bash
# Check if port 3000 is already in use
sudo lsof -i :3000

# Or use different port
docker run -d -p 8000:3000 36.255.69.72:443/myproject/express-app:1.0
```

### Issue: "TLS: no shared cipher suites" (self-signed cert)
```bash
# Add to /etc/docker/daemon.json
{
  "insecure-registries": ["36.255.69.72:443"]
}

# Restart Docker
sudo systemctl restart docker
```

### Issue: "manifest not found" when pulling
```bash
# Verify image was pushed successfully
docker push 36.255.69.72:443/myproject/express-app:1.0

# Check Harbor UI for the image
```

---

## Verification Checklist

- [ ] Node.js Express app created locally
- [ ] Docker image built successfully
- [ ] Image tested locally
- [ ] Docker logged into Harbor
- [ ] Image tagged with Harbor registry
- [ ] Image pushed to Harbor
- [ ] Image visible in Harbor UI
- [ ] Image pulled from Harbor
- [ ] Container runs from Harbor image
- [ ] API endpoints respond correctly
- [ ] Health check passes

---

## Next Steps

1. **Create CI/CD pipeline** - Automate build and push
2. **Add environment variables** - Make app configurable
3. **Implement logging** - Better debugging
4. **Add authentication** - Secure API endpoints
5. **Create docker-compose** - Multi-container setup
6. **Set up replication** - Multi-region deployment
7. **Configure webhooks** - Auto-redeploy on new image

---
